Hệ thống gồm 2 tác vụ chạy song song: tác vụ manage_cell thực thi chạy máy trạng thái để điều khiển hoạt động của BMS; tác vụ monitor_cell tiến hành đọc thông số từ ina219, tính toán dung lượng pin và hiệu chỉnh dung lượng pin dựa trên OCV mỗi khi OCV được cập nhật (OCV được đo ở tác vụ manage_cell). 
Các thống số của 1 cell gồm OCV (điện áp mạch hở của 2 đầu cell), V (hiệu điện thế 2 đầu cell), I (dòng qua cell), dung lượng pin C của cell.
Hệ thống gồm relay cell (đóng ngắt dòng ở cell), relay switch mode (chuyển đổi giữa chế độ sạc và xả của toàn cell), mosfet opto (chia dòng qua cell).
Khi ngắt dòng ở cell (openCurrentCell), thứ tự thực hiện là thông dòng qua mosfet (THROUGH) rồi mới ngắt dòng ở relay cell (OPEN).
Khi đóng dòng ở cell (closeCurrentCell), thứ tự thực hiện là đóng dòng ở relay cell (CLOSE) rồi mới chặn dòng qua mosfet (CUT_OFF).
Khi đo OCV của pin, thứ tự thực hiện như sau:
- Ngắt dòng ở cell.
- Ngưng tác vụ đang thực hiện đo OCV trong 5s.
- Đo điện áp Gán OCV = V.

Các trạng thái của hệ thống trong tác vụ manage_cell gồm:
{ INIT,             //khởi tạo, giống như code trong setup hiện tại 
  CHARGING,         // sạc cho cell
  DISCHARGING,      // xả cell
  FULLY_CHARGED,    // đã đầy (dừng sạc)
  PAUSED_HIGH_VOLT, // tạm dừng do quá áp sạc
  FAULT_OVERCURRENT,// lỗi quá dòng nghiêm trọng (ngắt vĩnh viễn)
  SOURCE_UNAVAILABLE }
Các trạng thái sẽ được xác định thời điểm thực thi bằng software timer.
  Trong đó:
    - CHARGING:
        + Điều khiển dòng: Đóng dòng sạc ở cell (CLOSE) và chuyển relay switch mode sang CHARGE.
        + Ngưng tác vụ trong 1s (để tránh nhiễu do tiếp điểm relay).
        + Kiểm tra thông số điện áp V, dòng điện I định kì mỗi CHECK_PERIOD_MS (1s):
            - Nếu |I| > CURRENT_MAX thì ngay lập tức chuyển sang state FAULT_OVERCURRENT.
            - Nếu V > VOLTAGE_CHARGE_MAX thì ngay lập tức chuyển sang state PAUSED_HIGH_VOLT. 
            - Nếu dung lượng pin >= BAT_CAPACITY_MAH thì chuyển sang state FULLY_CHARGED.
            - Nếu I < 0 hoặc V < OCV thì chuyển sang state SOURCE_UNAVAILABLE.
        + Kiểm tra OCV định kì mỗi OCV_PERIOD_MS (10s).
    - DISCHARGING:
        + Đóng dòng sạc ở cell (CLOSE) và chuyển relay switch mode sang DISCHARGE.
        + Ngưng tác vụ trong 1s (để tránh nhiễu do tiếp điểm relay).
        + Kiểm tra thông số V, I, C định kì mỗi CHECK_PERIOD_MS (1s): 
            - Nếu |I| > CURRENT_MAX thì ngay lập tức chuyển sang state FAULT_OVERCURRENT.
            - Nếu V < 0.75 * VOLTAGE_MINIMUM_THRESHOLD hoặc dung lượng pin C < BAT_CAPACITY_MAH thì chuyển sang state CHARGING.
    - FULLY_CHARGED:
        + Ngắt dòng sạc ở cell (OPEN).
        + Ngưng tác vụ trong 1s (để tránh nhiễu do tiếp điểm relay).
        + Kiểm tra thông số OCV và C định kì mỗi 10s: nếu OCV < VOLTAGE_MINIMUM_THRESHOLD hoặc C < CAPACITY_MINIMUM_THRESHOLD * BAT_CAPACITY_MAH (CAPACITY_MINIMUM_THRESHOLD = 40%) thì chuyển sang state CHARGING.
    - PAUSED_HIGH_VOLT:
        + Ngắt dòng sạc ở cell (CLOSE).
        + Ngưng tác vụ trong 3s.
        + Kiểm tra thông số V định kì mỗi RETRY_DELAY_MS như sau:
            - Đóng dòng sạc ở cell (CLOSE).
            - Ngưng tác vụ trong 1s (để tránh nhiễu do tiếp điểm relay).
            - Kiểm tra nếu V < VOLTAGE_CHARGE_MAX thì chuyển sang state CHARGING.
    - FAULT_OVERCURRENT:
        + Ngắt dòng sạc ở cell (OPEN).
        + Hiển thị cảnh báo trên LCD.
        + Ngưng tác vụ mãi mãi.
    - SOURCE_UNAVAILABLE:
        + Ngắt dòng sạc ở cell (CLOSE).
        + Ngưng tác vụ trong RETRY_DELAY_MS.
        + Kiểm tra thông số V, I định kì mỗi RETRY_DELAY_MS như sau:
            - Đóng dòng sạc ở cell (CLOSE).
            - Ngưng tác vụ trong 1s (để tránh nhiễu do tiếp điểm relay).
            - Kiểm tra nếu V >= OCV hoặc I >= 0 thì chuyển sang state CHARGING.
